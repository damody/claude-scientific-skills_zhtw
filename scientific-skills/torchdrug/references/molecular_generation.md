# 分子生成

## 概述

分子生成涉及創建具有所需性質的新分子結構。TorchDrug 支援無條件生成（探索化學空間）和條件生成（針對特定性質最佳化）。

## 任務類型

### AutoregressiveGeneration

透過逐步添加原子和鍵來生成分子。這種方法能夠在生成過程中進行細粒度控制和性質最佳化。

**關鍵特徵：**
- 序列性原子-鍵構建
- 支援生成過程中的性質最佳化
- 可以整合化學有效性約束
- 啟用多目標最佳化

**生成策略：**
1. **束搜尋**：每步保留前 k 個候選
2. **採樣**：機率性選擇以增加多樣性
3. **貪婪**：始終選擇最高機率動作

**性質最佳化：**
- 基於所需性質的獎勵塑形
- 即時約束滿足
- 多目標平衡（如效力 + 類藥性）

### GCPNGeneration（圖卷積策略網路）

使用強化學習生成針對特定性質最佳化的分子。

**組件：**
1. **策略網路**：決定採取何種動作（添加原子、添加鍵）
2. **獎勵函數**：評估生成分子的品質
3. **訓練**：使用策略梯度的強化學習

**優點：**
- 直接最佳化不可微分目標
- 可以整合複雜領域知識
- 平衡探索和利用

**應用：**
- 針對特定標靶的藥物設計
- 具有性質約束的材料發現
- 多目標分子最佳化

## 生成模型

### GraphAutoregressiveFlow

具有精確似然計算的分子生成正規化流模型。

**架構：**
- 耦合層將簡單分佈轉換為複雜分子分佈
- 可逆變換實現密度估計
- 支援條件生成

**關鍵特徵：**
- 精確似然計算（vs. VAE 的近似似然）
- 穩定訓練（vs. GAN 的對抗訓練）
- 通過可逆變換高效採樣
- 可以生成具有指定性質的分子

**訓練：**
- 在分子資料集上的最大似然
- 用於條件生成的可選性質預測頭
- 通常在 ZINC 或 QM9 上訓練

**使用案例：**
- 生成多樣的類藥分子
- 已知分子間的插值
- 分子空間的密度估計

## 生成工作流程

### 無條件生成

生成多樣分子而無特定性質目標。

**工作流程：**
1. 在分子資料集上訓練生成模型（如 ZINC250k）
2. 從學習的分佈中採樣
3. 後處理以確保有效性和唯一性
4. 評估多樣性指標

**評估指標：**
- **有效性**：化學有效分子的百分比
- **唯一性**：有效分子中唯一分子的百分比
- **新穎性**：不在訓練集中的百分比
- **多樣性**：使用指紋相似性的內部多樣性

### 條件生成

生成針對特定性質最佳化的分子。

**性質目標：**
- **類藥性**：LogP、QED、Lipinski 五規則
- **可合成性**：SA 分數、逆合成可行性
- **生物活性**：預測的 IC50、結合親和力
- **ADMET**：吸收、分佈、代謝、排泄、毒性
- **多目標**：同時平衡多個性質

**工作流程：**
1. 定義結合性質目標的獎勵函數
2. 在性質上訓練 GCPN 或條件流模型
3. 生成具有所需性質範圍的分子
4. 驗證生成的分子（矽內 → 濕實驗室）

### 基於骨架的生成

圍繞固定骨架或核心結構生成分子。

**應用：**
- 保持核心藥效團的先導化合物最佳化
- SAR 研究的 R 基團枚舉
- 片段連接和生長

**方法：**
- 訓練期間遮罩骨架
- 基於骨架的條件生成
- 生成後嫁接

### 基於片段的生成

從已驗證的片段構建分子。

**優點：**
- 確保類藥子結構
- 減少搜尋空間
- 整合藥物化學知識

**方法：**
- 片段庫作為構建模組
- 基於詞彙的生成
- 使用學習連接子的片段連接

## 性質最佳化策略

### 單目標最佳化

最大化或最小化單一性質（如結合親和力）。

**方法：**
- 定義標量獎勵函數
- 使用 RL 訓練的 GCPN
- 生成並排名候選物

**挑戰：**
- 可能犧牲其他重要性質
- 對抗性範例風險（有效但非類藥）
- 需要對類藥性的約束

### 多目標最佳化

平衡多個競爭目標（如效力、選擇性、可合成性）。

**加權方法：**
- **線性組合**：w1×性質1 + w2×性質2 + ...
- **帕累托最佳化**：尋找非支配解
- **約束滿足**：次要目標上的閾值

**範例目標：**
- 高結合親和力（標靶）
- 低結合親和力（脫靶）
- 高可合成性（SA 分數）
- 類藥性質（QED）
- 低分子量

**工作流程：**
```python
from torchdrug import tasks

# 定義多目標獎勵
def reward_function(mol):
    affinity_score = predict_binding(mol)
    druglikeness = calculate_qed(mol)
    synthesizability = sa_score(mol)

    # 加權組合
    reward = 0.5 * affinity_score + 0.3 * druglikeness + 0.2 * (1 - synthesizability)
    return reward

# 具有自訂獎勵的 GCPN 任務
task = tasks.GCPNGeneration(
    model,
    reward_function=reward_function,
    criterion="ppo"  # 近端策略最佳化
)
```

### 基於約束的生成

生成滿足硬約束的分子。

**常見約束：**
- 分子量範圍
- LogP 範圍
- 可旋轉鍵數量
- 環計數限制
- 子結構包含/排除
- 合成可及性閾值

**實作：**
- 生成期間的有效性檢查
- 無效分子的早停
- 獎勵函數中的懲罰項

## 訓練考量

### 資料集選擇

**ZINC（類藥化合物）：**
- ZINC250k：250,000 化合物
- ZINC2M：200 萬化合物
- 預過濾類藥性
- 適合藥物發現應用

**QM9（小型有機分子）：**
- 133,885 分子
- 包含量子性質
- 適合性質預測模型

**ChEMBL（生物活性分子）：**
- 數百萬生物活性化合物
- 有活性資料
- 標靶特定生成

**自訂資料集：**
- 專注於特定化學空間
- 包含專家知識
- 領域特定約束

### 資料增強

**SMILES 增強：**
- 為相同分子生成多個 SMILES
- 幫助模型學習規範表示
- 提高穩健性

**圖增強：**
- 隨機節點/邊遮罩
- 子圖採樣
- 基序替換

### 模型架構選擇

**小分子（<30 原子）：**
- 更簡單架構足夠
- 更快訓練和生成
- GCN 或 GIN 骨幹

**類藥分子：**
- 更深架構（4-6 層）
- 注意力機制有幫助
- 考慮分子指紋

**大環/聚合物：**
- 處理更大的圖
- 環閉合機制重要
- 長距離依賴性

## 驗證和過濾

### 矽內驗證

**化學有效性：**
- 價態規則
- 芳香性規則
- 電荷中性
- 穩定子結構

**類藥性過濾：**
- Lipinski 五規則
- Veber 規則
- PAINS 過濾（泛測定干擾化合物）
- BRENK 過濾（毒性/反應性子結構）

**可合成性：**
- SA 分數（合成可及性）
- 逆合成預測
- 前驅體的商業可用性

**性質預測：**
- ADMET 性質
- 毒性預測
- 脫靶結合
- 代謝穩定性

### 排名和選擇

**標準：**
1. 預測標靶親和力
2. 類藥性分數
3. 可合成性
4. 新穎性（與已知活性物的不相似度）
5. 多樣性（生成集內）
6. 預測 ADMET 性質

**選擇策略：**
- 帕累托前沿選擇
- 加權評分
- 聚類和代表性選擇
- 用於濕實驗室驗證的主動學習

## 最佳實踐

1. **從簡單開始**：先進行無條件生成，再添加約束
2. **驗證化學**：始終檢查有效分子和類藥性
3. **多樣訓練資料**：使用大型、多樣的資料集以更好泛化
4. **多目標**：從一開始就考慮多個性質
5. **迭代改進**：生成 → 驗證 → 使用反饋重訓練
6. **領域專家審查**：合成前諮詢藥物化學家
7. **基準測試**：與已知活性物和隨機樣本比較
8. **可合成性**：優先考慮實際可製造的分子
9. **可解釋性**：理解模型為何生成某些結構
10. **濕實驗室驗證**：最終實驗驗證有前途的候選物

## 常見應用

### 藥物發現
- 新標靶的先導化合物生成
- 圍繞活性骨架的先導化合物最佳化
- 生物電子等排體替換
- 片段延伸

### 材料科學
- 具有目標性質的聚合物設計
- 催化劑發現
- 儲能材料
- 光伏材料

### 化學生物學
- 探針分子設計
- 降解劑（PROTAC）設計
- 分子膠發現

## 與其他工具的整合

**對接：**
- 生成分子 → 對接到標靶 → 使用對接分數重訓練

**逆合成：**
- 按合成可及性過濾生成的分子
- 為頂級候選物規劃合成路線

**性質預測：**
- 使用訓練好的性質預測模型作為獎勵函數
- 生成和預測的多任務學習

**主動學習：**
- 生成候選物 → 預測性質 → 合成最佳 → 重訓練
