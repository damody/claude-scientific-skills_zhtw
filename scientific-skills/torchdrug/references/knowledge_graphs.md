# 知識圖譜推理

## 概述

知識圖譜以圖格式表示結構化資訊，包含實體和關係。TorchDrug 提供全面的知識圖譜補全（連結預測）支援，使用基於嵌入的模型和神經推理方法。

## 可用資料集

### 通用知識圖譜

**FB15k（Freebase 子集）：**
- 14,951 個實體
- 1,345 種關係類型
- 592,213 個三元組
- 來自 Freebase 的通用世界知識

**FB15k-237：**
- 14,541 個實體
- 237 種關係類型
- 310,116 個三元組
- 移除逆關係的過濾版本
- 更具挑戰性的基準

**WN18（WordNet）：**
- 40,943 個實體（詞義）
- 18 種關係類型（詞彙關係）
- 151,442 個三元組
- 語言學知識圖譜

**WN18RR：**
- 40,943 個實體
- 11 種關係類型
- 93,003 個三元組
- 移除簡單逆向模式的過濾版 WordNet

### 生物醫學知識圖譜

**Hetionet：**
- 45,158 個實體（基因、化合物、疾病、路徑等）
- 24 種關係類型（治療、導致、結合等）
- 2,250,197 條邊
- 整合 29 個公共生物醫學資料庫
- 設計用於藥物再利用和疾病理解

## 任務：KnowledgeGraphCompletion

知識圖譜的主要任務是連結預測 - 給定頭實體和關係，預測尾實體（或反之）。

### 任務模式

**頭預測：**
- 給定（?, 關係, 尾），預測頭實體
- 「什麼可能導致疾病 X？」

**尾預測：**
- 給定（頭, 關係, ?），預測尾實體
- 「基因 X 會導致哪些疾病？」

**兩者：**
- 預測頭和尾
- 標準評估協定

### 評估指標

**排名指標：**
- **Mean Rank（MR，平均排名）**：正確實體的平均排名
- **Mean Reciprocal Rank（MRR，平均倒數排名）**：1/排名的平均值
- **Hits@K**：前 K 個預測中正確實體的百分比
  - 通常報告 K=1、3、10

**過濾 vs 原始：**
- **過濾**：從排名中移除其他已知真實三元組
- **原始**：在所有可能實體中排名
- 過濾是評估的標準

## 嵌入模型

### 平移模型

**TransE（平移嵌入）：**
- 將關係表示為嵌入空間中的平移
- h + r ≈ t（頭 + 關係 ≈ 尾）
- 簡單且有效的基線
- 對 1 對 1 關係效果好
- 對 N 對 N 關係困難

**RotatE（旋轉嵌入）：**
- 關係作為複數空間中的旋轉
- 更好地處理對稱和逆向關係
- 在許多基準上達到最先進水準
- 可以建模組合模式

### 語義匹配模型

**DistMult：**
- 雙線性評分函數
- 自然處理對稱關係
- 無法建模非對稱關係
- 快速且記憶體效率高

**ComplEx：**
- 複數值嵌入
- 建模非對稱和逆向關係
- 對大多數圖比 DistMult 更好
- 平衡表達能力和效率

**SimplE：**
- 擴展 DistMult 以處理逆向關係
- 完全表達性（可以表示任何關係模式）
- 每個實體有兩個嵌入（規範和逆向）

### 神經邏輯模型

**NeuralLP（神經邏輯程式設計）：**
- 通過可微分操作學習邏輯規則
- 通過學習的規則解釋預測
- 對稀疏知識圖譜效果好
- 計算成本更高

**KBGAT（知識庫圖注意力）：**
- 用於知識圖譜補全的圖注意力網路
- 從鄰域學習實體表示
- 通過歸納學習處理未見實體
- 對不完整圖效果更好

## 訓練工作流程

### 基本管線

```python
from torchdrug import datasets, models, tasks, core

# 載入資料集
dataset = datasets.FB15k237("~/kg-datasets/")

# 定義模型
model = models.RotatE(
    num_entity=dataset.num_entity,
    num_relation=dataset.num_relation,
    embedding_dim=2000,
    max_score=9
)

# 定義任務
task = tasks.KnowledgeGraphCompletion(
    model,
    num_negative=128,
    adversarial_temperature=2,
    criterion="bce"
)

# 使用 PyTorch Lightning 或自訂循環訓練
```

### 負採樣

**策略：**
- **均勻**：均勻隨機採樣實體
- **自對抗**：根據當前模型的分數加權樣本
- **類型約束**：僅採樣關係的有效實體類型

**參數：**
- `num_negative`：每個正三元組的負樣本數
- `adversarial_temperature`：自對抗加權的溫度
- 更高溫度 = 更關注困難負樣本

### 損失函數

**二元交叉熵（BCE）：**
- 獨立處理每個三元組
- 正負之間的平衡分類

**邊界損失：**
- 確保正分數比負分數高出邊界
- `max(0, margin + score_neg - score_pos)`

**邏輯損失：**
- 邊界損失的平滑版本
- 更好的梯度特性

## 模型選擇指南

### 按關係模式

**1 對 1 關係：**
- TransE 效果好
- 任何模型都可能成功

**1 對 N 關係：**
- DistMult、ComplEx、SimplE
- 避免 TransE

**N 對 1 關係：**
- DistMult、ComplEx、SimplE
- 避免 TransE

**N 對 N 關係：**
- ComplEx、SimplE、RotatE
- 最具挑戰性的模式

**對稱關係：**
- DistMult、ComplEx
- RotatE 需要適當初始化

**反對稱關係：**
- ComplEx、SimplE、RotatE
- 避免 DistMult

**逆向關係：**
- ComplEx、SimplE、RotatE
- 對雙向推理重要

**組合：**
- RotatE（最佳）
- TransE（合理）
- 捕捉多跳路徑

### 按資料集特徵

**小型圖（< 50k 實體）：**
- ComplEx 或 SimplE
- 較低嵌入維度（200-500）

**大型圖（> 100k 實體）：**
- DistMult 追求效率
- RotatE 追求準確度
- 較高維度（500-2000）

**稀疏圖：**
- NeuralLP（從有限資料學習規則）
- 在更大圖上預訓練嵌入

**密集、完整圖：**
- 任何嵌入模型都效果好
- 根據關係模式選擇

**生物醫學/領域圖：**
- 考慮採樣中的類型約束
- 使用領域特定的負採樣
- Hetionet 受益於關係特定模型

## 進階技術

### 多跳推理

鏈接多個關係來回答複雜查詢：
- 「哪些藥物治療由基因 X 引起的疾病？」
- 需要基於路徑或基於規則的推理
- NeuralLP 自然支援這一點

### 時序知識圖譜

擴展到隨時間變化的事實：
- 為三元組添加時間資訊
- 預測未來事實
- 需要模型中的時間編碼

### 少樣本學習

處理只有少量範例的關係：
- 元學習方法
- 從相關關係遷移
- 對新興知識重要

### 歸納學習

泛化到未見實體：
- KBGAT 和其他基於 GNN 的方法
- 使用實體特徵/描述
- 對演化的知識圖譜至關重要

## 生物醫學應用

### 藥物再利用

在 Hetionet 中預測「藥物治療疾病」連結：
1. 在已知藥物-疾病關聯上訓練
2. 預測新的治療候選物
3. 按機制（基因、路徑參與）過濾
4. 實驗驗證預測

### 疾病基因發現

識別與疾病相關的基因：
1. 建模基因-疾病-路徑網路
2. 預測缺失的基因-疾病連結
3. 整合蛋白質交互作用、表達資料
4. 優先排序驗證候選物

### 蛋白質功能預測

將蛋白質連結到生物過程：
1. 整合蛋白質交互作用、GO 術語
2. 預測缺失的 GO 註釋
3. 從相似蛋白質遷移功能

## 常見問題和解決方案

**問題：特定關係類型表現不佳**
- 解決方案：分析關係模式，選擇適當模型，或使用關係特定模型

**問題：在小型圖上過擬合**
- 解決方案：減少嵌入維度，增加正則化，或使用更簡單的模型

**問題：大型圖上訓練緩慢**
- 解決方案：減少負樣本，使用 DistMult 追求效率，或實作小批次訓練

**問題：無法處理新實體**
- 解決方案：使用歸納模型（KBGAT），整合實體特徵，或根據鄰居預計算新實體的嵌入

## 最佳實踐

1. 對大多數任務從 ComplEx 或 RotatE 開始
2. 使用自對抗負採樣
3. 調整嵌入維度（通常 500-2000）
4. 應用正則化防止過擬合
5. 使用過濾評估指標
6. 分析每種關係類型的表現
7. 對異質圖考慮關係特定模型
8. 與領域專家驗證預測
